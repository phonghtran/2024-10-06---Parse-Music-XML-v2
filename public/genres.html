<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Express App</title>

    <style>
        .rowGenre {
            display: flex;
            flex-direction: row;
        }

        .playlistName {}

        .vizGenre {
            background-color: #eee;
            display: flex;
            flex-direction: row;
            flex-grow: 1;
        }

        .barViz {
            flex-grow: 1;
            font-size: 0.75rem;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="container"></div>


    <script>

        async function getColor(genre, idOffset) {
            const res = await fetch(`/colord?genre=${genre}`).then(response => {
                if (response.ok) { // Check if response is OK (200-299)
                    return response.json(); // If true, return the JSON data
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`); // Otherwise, rethrow an error
                }

            }).then(data => {
                // console.log(data, 'inside the then')

                const elem = document.getElementById(`barViz${idOffset}`)
                elem.dataset.score = data.bestScore.score
                elem.dataset.newGenre = data.bestScore.genre
                elem.dataset.color = data.bestScore.color

                // elem.style.backgroundColor = "#fff" // debug
                elem.style.backgroundColor = data.bestScore.color

                if (data.bestScore.score < .6) {
                    elem.innerHTML = data.bestScore.genre
                    // elem.innerHTML = '!!!' + elem.innerHTML //debug
                    // elem.style.backgroundColor = "yellow" //debug
                    console.log(elem.dataset.genre)
                }

                return data
            }).catch(error => console.error('Error color tracks:', error))



        }





        fetchTable()



        async function fetchTable() {

            const render = await fetch(`/genresgraph`)
                .then(response => {
                    if (response.ok) { // Check if response is OK (200-299)
                        return response.json(); // If true, return the JSON data
                    } else {
                        throw new Error(`Error ${response.status}: ${response.statusText}`); // Otherwise, rethrow an error
                    }

                })
                .then(data => {

                    let grouped = data.reduce((acc, track) => {
                        const playlistName = track.playlistName;
                        if (!acc[playlistName]) acc[playlistName] = [];
                        acc[playlistName].push(track);
                        return acc;
                    }, {});

                    const container = document.getElementById('container')

                    let tempcount = 0

                    for (pl in grouped) {
                        const plist = grouped[pl]

                        const rowGenre = document.createElement('div')
                        rowGenre.classList.add('rowGenre')

                        const playlistName = document.createElement('div')
                        playlistName.textContent = pl
                        playlistName.classList.add('playlistName')
                        rowGenre.appendChild(playlistName)



                        const vizGenre = document.createElement('div')
                        vizGenre.classList.add('vizGenre')



                        let genreCount = 0;
                        for (var i = 0; i < plist.length; i++) {
                            const track = plist[i]
                            genreCount += track.count
                        }//count total

                        let color = 0
                        for (var i = 0; i < plist.length; i++) {
                            const track = plist[i]

                            // console.log(track)

                            const barViz = document.createElement('div')
                            barViz.id = `barViz${tempcount}`
                            barViz.classList.add('barViz')
                            barViz.classList.add(`barVizColor${color}`)
                            barViz.dataset.genre = track.genre
                            barViz.dataset.count = track.count
                            barViz.style.width = `${track.count / genreCount}%`
                            // barViz.style.backgroundColor = hexColors[color]
                            barViz.textContent = track.genre



                            try {
                                getColor(track.genre, tempcount); // assumes this is an 
                            } catch (error) {
                                console.error(error);
                            }



                            tempcount++


                            vizGenre.appendChild(barViz)

                            color++

                        } // each track



                        rowGenre.appendChild(vizGenre)
                        container.appendChild(rowGenre)
                    }// for




                })
                .catch(error => console.error('Error fetching tracks:', error))
                ;
        }// fetch table
    </script>
</body>

</html>