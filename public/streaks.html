<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Express App</title>

    <style>
        table {
            border-collapse: collapse;
            border: 1px solid black;
        }

        .double {
            background-color: yellow;
        }



        .hidden {
            display: none;
        }

        button.isActive {
            background-color: yellow;
        }

        th,
        td {
            border: 1px solid black;
            min-width: 6rem;
        }

        #bttnToggleMulti {
            display: none;
        }
    </style>
</head>

<body>
    <p>
        <a href="/index.html">Home</a>
    </p>
    <p>
        <button id="bttnStreaks" class="isActive">Longest Streak</button>
        <button id="bttnName">Alphabetical</button>
        <button id="bttnMostDays">Artists with Most Days</button>
        <button id="bttnMostEntries">Artists with Most Entries</button>

        <button id="bttnToggleMulti">Show Only Songs with Multiple</button>
    </p>
    <div id="container">
        <table id="tableStreaks"></table>
    </div>


    <script>
        let bigList = {
            raw: [],
            alpha: [],
            longest: []
        }
        let bigListArtist = {
            raw: [],
            most: [],
            longest: []
        }
        let alphaShowAll = true

        const bttnStreaks = document.getElementById('bttnStreaks')
        const bttnName = document.getElementById('bttnName')
        const bttnMostEntries = document.getElementById('bttnMostEntries')
        const bttnMostDays = document.getElementById('bttnMostDays')

        const bttnToggleMulti = document.getElementById('bttnToggleMulti')




        bttnStreaks.addEventListener('click', (e) => {
            // bigList.sort((a, b) => b[1][0] - a[1][0]);
            // console.log(bigList)

            bttnStreaks.classList.add('isActive')
            bttnName.classList.remove('isActive')
            bttnMostEntries.classList.remove('isActive')
            bttnMostDays.classList.remove('isActive')
            sortTable(true)
        })

        bttnName.addEventListener('click', (e) => {
            // bigList.sort((a, b) => b[0][0] - a[0][0]);
            // console.log(bigList)

            bttnStreaks.classList.remove('isActive')
            bttnName.classList.add('isActive')
            bttnMostEntries.classList.remove('isActive')
            bttnMostDays.classList.remove('isActive')
            sortTable(false)


        })

        bttnMostEntries.addEventListener('click', (e) => {
            // bigList.sort((a, b) => b[0][0] - a[0][0]);
            // console.log(bigList)

            bttnStreaks.classList.remove('isActive')
            bttnName.classList.remove('isActive')
            bttnMostEntries.classList.add('isActive')
            bttnMostDays.classList.remove('isActive')

            mostEntries(false)


        })

        bttnMostDays.addEventListener('click', (e) => {
            // bigList.sort((a, b) => b[0][0] - a[0][0]);
            // console.log(bigList)

            bttnStreaks.classList.remove('isActive')
            bttnName.classList.remove('isActive')
            bttnMostEntries.classList.remove('isActive')
            bttnMostDays.classList.add('isActive')
            mostEntries(true)


        })


        bttnToggleMulti.addEventListener('click', (e) => {
            // bigList.sort((a, b) => b[0][0] - a[0][0]);
            // console.log(bigList)
            bttnStreaks.classList.remove('isActive')
            bttnName.classList.add('isActive')
            bttnMostEntries.classList.remove('isActive')

            const container = document.getElementById('container')

            sortTable(false)


            const rows = document.getElementsByTagName('tr')

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i]

                if (!row.classList.contains('double')) {
                    row.classList.add('hidden')
                }

            }





        })


        async function sortTable(flag) {


            let container = document.getElementById('container')
            container.innerHTML = ''

            let tableStreaks = document.createElement('table')
            tableStreaks.innerHTML = '<tr><th>Song</th><th>Streak</th><th>Start Date</th><th>End Date</th></tr>'



            const list = (flag) ? 'longest' : 'alpha'

            // console.log(list)

            // bigList.sort((a, b) => b[1][0] - a[1][0]);

            let doubleFlag = false

            for (var i = 0; i < bigList[list].length; i++) {
                const tr = document.createElement('tr')

                const td = document.createElement('td')
                td.textContent = bigList[list][i][0]['pairedName']
                //`${track.artist} - ${track.name}`

                if (doubleFlag === true) {
                    tr.classList.add('double')
                    doubleFlag = false
                }
                if (i < bigList[list].length - 1 && list === 'alpha') {
                    if (bigList[list][i][0]['pairedName'] === bigList[list][i + 1][0]['pairedName']) {
                        tr.classList.add('double')
                        doubleFlag = true
                    }
                }



                tr.appendChild(td)

                // console.log(bigList[i])

                for (j = 0; j < bigList[list][i][1].length; j++) {
                    const td = document.createElement('td')
                    td.textContent = bigList[list][i][1][j]
                    td.textContent += (j === 0) ? ' days' : ''
                    tr.appendChild(td)

                } // metadata loop

                tableStreaks.appendChild(tr)

            } // loop entry

            await container.appendChild(tableStreaks)

        }  // sortTable

        async function mostEntries(flag) {

            let container = document.getElementById('container')
            container.innerHTML = ''

            let tableStreaks = document.createElement('table')

            const list = (flag) ? 'longest' : 'most'

            tableStreaks.innerHTML = '<tr><th>Artist</th><th>Entries</th><th>Total Days</th></tr>'



            for (var i = 0; i < bigListArtist[list].length; i++) {
                const tr = document.createElement('tr')

                // console.log(bigListArtist[list][i])

                let td = document.createElement('td')
                td.textContent = bigListArtist[list][i][0]

                tr.appendChild(td)

                let td2 = document.createElement('td')
                td2.textContent = bigListArtist[list][i][1]

                tr.appendChild(td2)

                let td3 = document.createElement('td')
                td3.textContent = bigListArtist[list][i][2]

                tr.appendChild(td3)

                tableStreaks.appendChild(tr)

            } // loop entry

            await container.appendChild(tableStreaks)

        }

        fetch(`/tracks?sort=pairedName`)
            .then(response => {
                return response.json()

            })
            .then(data => {

                const container = document.getElementById('container')


                let grouped = data.reduce((acc, track) => {
                    const playlistName = track.pairedName;
                    if (!acc[playlistName]) acc[playlistName] = [];
                    acc[playlistName].push(track);
                    return acc;
                }, {});

                // debug = 0

                for (pl in grouped) {
                    const plist = grouped[pl]
                    // if (pl === 'amincaroline') console.log(pl, plist)

                    // debug++
                    // if (debug > 20) break;

                    let date1 = ''
                    let prevDate = ''
                    let streaks = []
                    let streakOffset = 0;

                    streaks[streakOffset] = ['', '', ''] // days, start date, end date



                    // const divPl = document.createElement('div')
                    // // const panelListing = document.createElement('ul')
                    // const panelHeader = document.createElement('h2')
                    // const panelDate = document.createElement('ul')

                    let label = {
                        artist: '',
                        name: '',
                        pairedName: ''
                    }

                    if (plist.length > 1) {
                        // console.log('more than 1')
                        for (var i = 0; i < plist.length; i++) {
                            const track = plist[i]

                            // if (i === 15) console.log(track)

                            label = {
                                artist: track.artist,
                                name: track.name,
                                pairedName: `${track.artist} - ${track.name}`
                            }



                            // const li = document.createElement('li')
                            // li.textContent = track.playlistName

                            // panelListing.appendChild(li)
                            // console.log(track)

                            // panelHeader.innerHTML = `${track.artist} - ${track.name}`



                            if (date1 === '') {
                                date1 = new Date(track.playlistName)
                                prevDate = new Date(track.playlistName)

                                streaks[streakOffset][1] = track.playlistName
                            }
                            const date2 = new Date(track.playlistName);

                            const relative_ms = Math.abs(date2.getTime() - prevDate.getTime());
                            const relative_days = Math.floor(relative_ms / (1000 * 60 * 60 * 24));

                            const milliseconds = Math.abs(date2.getTime() - date1.getTime());
                            const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));

                            // console.log(relative_days, days)

                            if (relative_days > 21) {


                                streakOffset++;
                                streaks[streakOffset] = ['', track.playlistName, '']
                                date1 = date2
                                prevDate = date2

                            } else {
                                streaks[streakOffset][0] = days
                                streaks[streakOffset][2] = track.playlistName

                                prevDate = new Date(track.playlistName)
                            }

                        }//tracks

                        for (var i = 0; i < streaks.length; i++) {
                            if (streaks[i][0] > 0) {
                                bigList['raw'].push([
                                    label,
                                    streaks[i]
                                ])
                            }
                        }



                    } // more than one in plist


                } // grouped



                let a = JSON.parse(JSON.stringify(bigList.raw));
                a.sort((a, b) => b[1][0] - a[1][0]);
                bigList.longest = a

                a = JSON.parse(JSON.stringify(bigList.raw));
                a.sort((a, b) => b[0]['pairedName'] - a[0]['pairedName'])

                bigList.alpha = a

                // console.log(bigList)

                let artists = {}

                for (var i = 0; i < bigList['alpha'].length - 1; i++) {
                    const iEntry = bigList['alpha'][i]
                    const artist = iEntry[0]['artist']

                    if (!artists[artist]) artists[artist] = {
                        entries: 0,
                        days: 0
                    }
                    artists[artist]['entries']++
                    artists[artist]['days'] += iEntry[1][0]

                } // loop i 

                for (artist in artists) {
                    bigListArtist['raw'].push([
                        artist,
                        artists[artist]['entries'],
                        artists[artist]['days']
                    ])
                }



                a = JSON.parse(JSON.stringify(bigListArtist.raw));
                a.sort((a, b) => b[2] - a[2]);
                bigListArtist.longest = a

                a = JSON.parse(JSON.stringify(bigListArtist.raw));
                a.sort((a, b) => b[1] - a[1]);

                bigListArtist.most = a


                console.log(bigListArtist)
                sortTable(true)



            }) // then 
            .catch(error => console.error('Error fetching info about track:', error))
            ;
    </script>
</body>

</html>